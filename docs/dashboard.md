# Dashboard API Documentation

## Overview

The Dashboard API provides comprehensive data for the SMS Blossom Shopify App dashboard, including SMS performance metrics, wallet information, contact statistics, and recent activity.

## Base URL

```
https://sms-blossom-api.onrender.com
```

## Authentication

All Dashboard endpoints require Shopify App authentication using session tokens.

### Required Headers

```http
Authorization: Bearer <shopify_session_token>
Content-Type: application/json
X-Request-ID: <optional_request_id>
```

### Shop Context

The API automatically resolves shop context from:

1. **Session Token** - `dest` claim in JWT
2. **Query Parameter** - `?shop=shop.myshopify.com`
3. **Header** - `X-Shopify-Shop-Domain: shop.myshopify.com`

## Endpoints

### 1. GET /dashboard/overview

Get comprehensive dashboard data including SMS metrics, wallet status, contacts, and recent activity.

#### Request

```http
GET /dashboard/overview?from=2024-01-01&to=2024-01-31&window=30d
Authorization: Bearer <shopify_session_token>
Content-Type: application/json
```

#### Query Parameters

| Parameter | Type   | Required | Default     | Description                      |
| --------- | ------ | -------- | ----------- | -------------------------------- |
| `from`    | string | No       | 30 days ago | Start date (ISO 8601)            |
| `to`      | string | No       | now         | End date (ISO 8601)              |
| `window`  | string | No       | 30d         | Predefined window (7d, 30d, 90d) |

#### Response

```json
{
  "success": true,
  "data": {
    "period": {
      "from": "2024-01-01T00:00:00.000Z",
      "to": "2024-01-31T23:59:59.999Z",
      "window": "30d"
    },
    "sms": {
      "sent": 150,
      "delivered": 145,
      "failed": 5,
      "deliveryRate": 96.67,
      "optIns": 25,
      "optOuts": 3
    },
    "wallet": {
      "balanceCents": 5000,
      "totalPurchasedCents": 10000,
      "totalUsedCents": 5000,
      "isActive": true,
      "creditLimitCents": null,
      "periodUsage": 1500,
      "periodPurchases": 2000,
      "periodSmsCount": 50,
      "costPerMessage": 300
    },
    "contacts": {
      "total": 500,
      "optedIn": 450,
      "optedOut": 50,
      "optInRate": 90.0
    },
    "campaigns": {
      "total": 10,
      "active": 3
    },
    "recentActivity": {
      "messages": [
        {
          "id": "msg_123",
          "body": "Thank you for your purchase! Your order #1234 is confirmed...",
          "status": "delivered",
          "kind": "automation",
          "triggerKey": "order_paid",
          "sentAt": "2024-01-15T10:30:00.000Z",
          "deliveredAt": "2024-01-15T10:30:05.000Z",
          "failedAt": null,
          "createdAt": "2024-01-15T10:30:00.000Z"
        }
      ],
      "transactions": [
        {
          "id": "tx_456",
          "type": "purchase",
          "amountCents": 5000,
          "currency": "EUR",
          "description": "SMS Credits Purchase - â‚¬50.00 EUR",
          "paymentStatus": "succeeded",
          "createdAt": "2024-01-10T14:20:00.000Z"
        }
      ]
    },
    "attribution": {
      "attributedOrders": 12,
      "revenueByCampaign": 2500.0,
      "discountUtilization": 0.75
    }
  }
}
```

#### Response Fields

##### Period

- `from` - Start date of the reporting period
- `to` - End date of the reporting period
- `window` - Predefined window used

##### SMS Performance

- `sent` - Total SMS messages sent
- `delivered` - Successfully delivered messages
- `failed` - Failed message deliveries
- `deliveryRate` - Percentage of successful deliveries
- `optIns` - New opt-ins during period
- `optOuts` - Opt-outs during period

##### Wallet Information

- `balanceCents` - Current credit balance (in cents)
- `totalPurchasedCents` - Total credits ever purchased
- `totalUsedCents` - Total credits ever used
- `isActive` - Whether wallet is active
- `creditLimitCents` - Credit limit (null if unlimited)
- `periodUsage` - Credits used in period
- `periodPurchases` - Credits purchased in period
- `periodSmsCount` - SMS count in period
- `costPerMessage` - Average cost per message (in cents)

##### Contacts

- `total` - Total number of contacts
- `optedIn` - Contacts with SMS consent
- `optedOut` - Contacts who opted out
- `optInRate` - Percentage of opted-in contacts

##### Campaigns

- `total` - Total number of campaigns
- `active` - Currently active campaigns

##### Recent Activity

- `messages` - Array of recent SMS messages (last 10)
- `transactions` - Array of recent wallet transactions (last 5)

##### Attribution

- `attributedOrders` - Orders attributed to SMS campaigns
- `revenueByCampaign` - Revenue generated by campaigns
- `discountUtilization` - Discount code utilization rate

### 2. GET /dashboard/quick-stats

Get quick statistics for dashboard widgets.

#### Request

```http
GET /dashboard/quick-stats?period=7d
Authorization: Bearer <shopify_session_token>
Content-Type: application/json
```

#### Query Parameters

| Parameter | Type   | Required | Default | Description                |
| --------- | ------ | -------- | ------- | -------------------------- |
| `period`  | string | No       | 7d      | Time period (7d, 30d, 90d) |

#### Response

```json
{
  "success": true,
  "data": {
    "period": "7d",
    "smsSent": 25,
    "walletBalance": 5000,
    "optedInContacts": 450,
    "isWalletActive": true
  }
}
```

#### Response Fields

- `period` - Time period for statistics
- `smsSent` - SMS messages sent in period
- `walletBalance` - Current wallet balance (in cents)
- `optedInContacts` - Number of opted-in contacts
- `isWalletActive` - Whether wallet is active

## Error Responses

### 400 Bad Request

```json
{
  "error": "missing_shop",
  "message": "Shop parameter is required",
  "request_id": "req_123"
}
```

### 401 Unauthorized

```json
{
  "code": "SHOP_NOT_AVAILABLE",
  "error": "unauthorized",
  "message": "Invalid or expired session token"
}
```

### 500 Internal Server Error

```json
{
  "error": "dashboard_fetch_failed",
  "message": "Failed to fetch dashboard data"
}
```

## Rate Limiting

- **Rate Limit**: 600 requests per minute
- **Burst Limit**: 60 requests per second
- **Headers**: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`

## CORS

- **Allowed Origins**:
  - `https://admin.shopify.com`
  - `https://sms-blossom-frontend.onrender.com`
- **Methods**: GET, POST, PUT, PATCH, DELETE, OPTIONS
- **Headers**: Authorization, Content-Type, X-Requested-With
- **Credentials**: true

## Shopify App Integration

### Frontend Implementation

```typescript
// Example React component
import { useAuthenticatedFetch } from '@shopify/app-bridge-react';

export function Dashboard() {
  const fetch = useAuthenticatedFetch();

  const loadDashboardData = async () => {
    const response = await fetch('/api/dashboard/overview');
    const data = await response.json();
    return data;
  };

  // Component implementation...
}
```

### Session Token

The session token is automatically provided by Shopify App Bridge:

```javascript
// Shopify App Bridge automatically handles:
// - Session token generation
// - Token refresh
// - Shop context resolution
```

### Error Handling

```typescript
try {
  const response = await fetch('/api/dashboard/overview');

  if (!response.ok) {
    if (response.status === 401) {
      // Handle authentication error
      // Redirect to login or refresh token
    } else if (response.status === 400) {
      // Handle bad request
      const error = await response.json();
      console.error('Request error:', error.message);
    }
  }

  const data = await response.json();
  return data;
} catch (error) {
  console.error('Network error:', error);
}
```

## Business Logic

### Credit System Integration

The dashboard integrates with the credit-based billing system:

1. **Wallet Status** - Shows current credit balance and usage
2. **Cost Tracking** - Displays SMS costs and efficiency metrics
3. **Transaction History** - Recent credit purchases and usage
4. **Credit Validation** - Ensures sufficient credits before SMS sending

### SMS Performance Metrics

- **Delivery Rate** - Calculated as `(delivered / sent) * 100`
- **Cost Efficiency** - Average cost per message
- **Opt-in Rate** - Percentage of contacts with SMS consent
- **Campaign Performance** - Active campaigns and their status

### Data Aggregation

- **Time-based Filtering** - Flexible date range selection
- **Real-time Updates** - Fresh data on each request
- **Caching** - Optimized for performance with Redis caching
- **Pagination** - Efficient handling of large datasets

## Security Considerations

### Authentication

- **Session Token Verification** - Validates Shopify session tokens
- **Shop Context Validation** - Ensures requests are for correct shop
- **Token Expiration** - Handles expired tokens gracefully

### Data Protection

- **PII Encryption** - Sensitive data is encrypted at rest
- **Access Control** - Shop-scoped data access only
- **Audit Logging** - All requests are logged for security

### Rate Limiting

- **Per-shop Limits** - Individual rate limits per shop
- **Burst Protection** - Prevents abuse during high traffic
- **Graceful Degradation** - Continues working even if Redis is down

## Monitoring & Observability

### Metrics

- **Request Count** - Total API requests
- **Response Time** - Average response time
- **Error Rate** - Percentage of failed requests
- **Cache Hit Rate** - Redis cache efficiency

### Logging

- **Request Logging** - All requests logged with context
- **Error Logging** - Detailed error information
- **Performance Logging** - Slow query detection
- **Security Logging** - Authentication and authorization events

## Testing

### Unit Tests

```bash
npm test -- --grep "dashboard"
```

### Integration Tests

```bash
npm run test:integration -- --grep "dashboard"
```

### Manual Testing

```bash
# Test with curl
curl -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     "https://sms-blossom-api.onrender.com/dashboard/overview?shop=test.myshopify.com"
```

## Changelog

### v1.0.0

- Initial dashboard API implementation
- SMS performance metrics
- Wallet integration
- Contact statistics
- Recent activity tracking
- Shopify App authentication
- Rate limiting and CORS
